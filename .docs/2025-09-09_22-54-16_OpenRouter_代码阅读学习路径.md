# OpenRouter 代码阅读学习路径

面向希望系统性了解项目中 OpenRouter 接入与流式输出链路的同学。按顺序阅读，结合命令检索与测试定位关键实现。

## 阅读目标

- 理解 Provider 注册/映射、参数构建与中间件、流事件适配到 UI 的全链路。
- 掌握 OpenRouter 的特性字段（citations、cost）如何被识别与展示。

## 推荐阅读顺序（文件 → 关注点）

1. `src/renderer/src/aiCore/provider/providerInitialization.ts`

- 动态注册 OpenRouter（@openrouter/ai-sdk-provider）。

2. `src/renderer/src/aiCore/provider/factory.ts`

- `getAiSdkProviderId` 的 ID/别名解析；`createAiSdkProvider` 构造 Provider。

3. `src/renderer/src/aiCore/provider/providerConfig.ts`

- `providerToAiSdkConfig` 组装 baseURL/apiKey；`prepareSpecialProviderConfig` 特殊供应商处理。

4. `src/renderer/src/aiCore/prepareParams/parameterBuilder.ts`

- `buildStreamTextParams` 生成 messages/system、maxTokens、tools、providerOptions。

5. `src/renderer/src/aiCore/utils/websearch.ts`

- OpenRouter 注入 `plugins: [{ id: 'web', search_prompts: ... }]` 的逻辑。

6. `src/renderer/src/aiCore/utils/reasoning.ts`

- OpenRouter 与不同模型的 reasoning/thinking 配置差异。

7. `src/renderer/src/services/ApiService.ts`

- 入口 `fetchChatCompletion`：串联参数构建与执行、onChunk 回调。

8. `src/renderer/src/aiCore/index_new.ts`

- `modernCompletions` 调用 `createExecutor(.....streamText(....`；与中间件/插件的衔接。

9. `src/renderer/src/aiCore/chunk/AiSdkToChunkAdapter.ts`

- 将 AI SDK 的 `text-* / reasoning-* / tool-* / source / finish` 转为统一 ChunkType。

10. `src/renderer/src/aiCore/legacy/middleware/common/FinalChunkConsumerMiddleware.ts`

- 用量与费用累计（含 OpenRouter `cost` 聚合）。

11. 展示与测试

- `src/renderer/src/pages/home/Messages/MessageTokens.tsx`（OpenRouter 费用显示）
- `src/renderer/src/services/__tests__/ApiService.test.ts`（OpenRouter citations/流式测试）

## 快速检索命令

- 定位 OpenRouter 相关：`rg -n "openrouter" -S`
- 查看 citations/费用使用：`rg -n "citations|cost" src/renderer -S`
- 追流式入口：`rg -n "streamText\(|fullStream" src/renderer/src/aiCore -S`

## 本地验证与测试

- 运行渲染层用例：`yarn test:renderer`
- 聚焦 API Service：`yarn test:renderer --filter ApiService`
- 覆盖率：`yarn test:coverage`

## 建议的小练习

- 在 `providerConfig.ts` 打印 OpenRouter 的 `providerId/options`，对比不同模型（如 sonar）。
- 在 `AiSdkToChunkAdapter` 打印 `finish-step` 的 `providerMetadata`，观察 OpenRouter citations 上屏路径。
- 切换是否启用内置搜索（`isOpenRouterBuiltInWebSearchModel`）对比请求差异。
